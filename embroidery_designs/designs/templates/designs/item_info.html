{% extends 'base.html' %}
{% load static %}
{% block title %}
{{ design.title }}
{% endblock title %}

{% block content %}

<div class="container">
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –≤ —à–∞–ø–∫–µ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <button onclick="window.history.back()" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                        </button>
                        <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∑–∞–π–Ω–µ</h5>
                        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-th"></i> –í—Å–µ –¥–∏–∑–∞–π–Ω—ã
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <img src="{{ design.image_preview.url }}" class="card-img-top" alt="{{ design.title }}" style="max-height: 500px; object-fit: contain;">
                            </div>
                        </div>
                        
                        
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h1 class="card-title h2">{{ design.title }}</h1>
                                    <div class="design-card">
                                        <div class="design-like">
                                            <button class="like-btn {% if is_favorite %}active{% endif %}"
                                                    data-id="{{ design.id }}"
                                                    data-is-favorite="{{ is_favorite|yesno:'true,false' }}"
                                                    aria-pressed="{{ is_favorite|yesno:'true,false' }}"
                                                    title="{% if is_favorite %}–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}">
                                                <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart heart-icon" aria-hidden="true"></i>
                                            </button>
                                            <span class="favorites-count">{{ design.favorites.count }}</span>
                                        </div>

                                        {% comment %} <button
                                            id="favorite-btn"
                                            data-design-id="{{ design.id }}"
                                            class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %}"
                                        >
                                            <span id="favorite-icon">
                                                {% if is_favorite %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                                            </span>
                                        </button> 

                                        <span id="favorites-count">{{ design.favorites.count }}</span>{% endcomment %}

                                        
                                    </div>
                                    <p class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ design.category.name }}</p>
                                    
                                    <div class="mb-4">
                                        <h3 class="text-primary">{{ design.price }}</h3>
                                    </div>

                                    <!-- –†–µ–π—Ç–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                                    <div class="rating-stats mb-4">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <!-- –ó–≤–µ–∑–¥—ã —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                                                    <div class="rating-stars me-3">
                                                        {% with stats=design.get_rating_stats %}
                                                        <div class="star-rating" data-design-id="{{ design.id }}">
                                                            {% for i in "12345" %}
                                                                {% with i=i|add:0 %}
                                                                <span class="star {% if i <= stats.average %}filled{% endif %}" 
                                                                        data-rating="{{ i }}">
                                                                    <i class="fas fa-star"></i>
                                                                </span>
                                                                {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ stats.average|default:0 }} ({{ stats.count }} –æ—Ü–µ–Ω–æ–∫)
                                                        </small>
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="purchase-stats text-end">
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-shopping-cart"></i>
                                                        –ö—É–ø–ª–µ–Ω–æ: {{ design.get_purchase_count }} —Ä–∞–∑
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- –§–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                                        {% comment %} {% if user.is_authenticated and not purchased %}
                                        <div class="user-rating mt-3">
                                            <form class="rating-form" method="post" action="{% url 'rate_design' design.id %}">
                                                {% csrf_token %}
                                                <small class="text-muted">–û—Ü–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç –¥–∏–∑–∞–π–Ω:</small>
                                                <div class="rating-buttons mt-1">
                                                    {% for i in "12345" %}
                                                        {% with i=i|add:0 %}
                                                        <button type="submit" name="rating" value="{{ i }}" 
                                                                class="btn btn-sm btn-outline-warning rating-btn {% if design.get_user_rating.user == i %}active{% endif %}"
                                                                title="–û—Ü–µ–Ω–∏—Ç—å {{ i }} –∑–≤–µ–∑–¥">
                                                            <i class="fas fa-star"></i> {{ i }}
                                                        </button>
                                                        {% endwith %}
                                                    {% endfor %}
                                                </div>
                                            </form>
                                        </div>
                                        {% endif %} {% endcomment %}

                                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–µ–∂–∫–∞—Ö –∏ –ø—è–ª—å—Ü–∞—Ö -->
                                        <div class="design-specs mb-4">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <strong><i class="fas fa-shoe-prints"></i> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–µ–∂–∫–æ–≤:</strong>
                                                        <br>
                                                        <span class="badge bg-primary mt-1">{{ design.get_stitch_count_display }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <strong><i class="fas fa-vector-square"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—è–ª—å—Ü–∞:</strong>
                                                        <br>
                                                        <div class="mt-1">
                                                            {% for hoop in design.compatible_hoops.all %}
                                                            <span class="badge bg-info me-1" title="{{ hoop.compatible_machines }}">
                                                                {{ hoop.code }}
                                                            </span>
                                                            {% empty %}
                                                            <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="design-info mb-4">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <strong><i class="fas fa-robot"></i> –ú–∞—à–∏–Ω—ã:</strong>
                                                    <br>
                                                    <span class="badge bg-secondary mt-1">{{ design.get_machine_type_display }}</span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <strong><i class="fas fa-ruler"></i> –†–∞–∑–º–µ—Ä:</strong>
                                                    <br>
                                                    <span class="badge bg-info mt-1">{{ design.design_size }} mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="description mb-4">
                                        <h5>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
                                        <p class="card-text">{{ design.description|linebreaks }}</p>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        {% if user.is_authenticated %}
                                            {% comment %} {% if purchased %}
                                                <button class="btn btn-success btn-lg w-100" disabled>
                                                    <i class="fas fa-check"></i> –£–∂–µ –∫—É–ø–ª–µ–Ω–æ
                                                </button>
                                                <div class="text-center mt-2">
                                                    <p>–¢–∞–∫ –∂–µ –º–æ–∂–µ—Ç–µ:</p>
                                                    <a href="{% url 'my_designs' %}" class="btn btn-outline-primary">
                                                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
                                                    </a>
                                                </div>
                                            {% else %}
                                                {% if price_data.discount_percent > 0 %}
                                                    <div class="text-center mb-2">
                                                        <span class="text-muted text-decoration-line-through">${{ price_data.base_price }}</span>
                                                        <span class="text-danger fw-bold">${{ price_data.final_price }}</span>
                                                        <span class="badge bg-success">-{{ price_data.discount_percent }}%</span>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center mb-2">
                                                        <span class="fw-bold">${{ price_data.final_price }}</span>
                                                    </div>
                                                {% endif %}
                                                <a href="{% url 'create_payment' design.id %}" class="btn btn-primary btn-lg w-100">
                                                    <i class="fas fa-shopping-cart"></i> –ö—É–ø–∏—Ç—å
                                                </a>
                                            {% endif %} {% endcomment %}
                                            {% if purchased %}
                                                <button class="btn btn-success btn-lg w-100" disabled>
                                                    <i class="fas fa-check"></i> –£–∂–µ –∫—É–ø–ª–µ–Ω–æ
                                                </button>
                                                <div class="text-center mt-2">
                                                    <p>–¢–∞–∫ –∂–µ –º–æ–∂–µ—Ç–µ:</p>
                                                    <a href="{% url 'my_designs' %}" class="btn btn-outline-primary">
                                                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å –≤ "–º–æ–∏ –¥–∏–∑–∞–π–Ω—ã"
                                                    </a>
                                                </div>
                                            {% else %}
                                                <a href="{% url 'create_payment' design.id %}" class="btn btn-primary btn-lg w-100">
                                                    <i class="fas fa-shopping-cart"></i> –ö—É–ø–∏—Ç—å –∑–∞ ${{ price_data.final_price }}
                                                    {% if price_data.discount_percent %}
                                                        <span class="badge bg-success">{{ price_data.discount_percent }}% —Å–∫–∏–¥–∫–∞</span>
                                                    {% endif %}
                                                </a>
                                                <div class="discount">
                                                    {% if price_data.discount_ends_in %}
                                                        <p class="mt-2 text-muted small">
                                                            –°–∫–∏–¥–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –µ—â—ë: {{ price_data.discount_ends_in }}
                                                        </p>
                                                    {% endif %}
                                                </div>
                                            {% endif %}

                                        {% else %}
                                            <div class="alert alert-warning">
                                                <p>–î–ª—è –ø–æ–∫—É–ø–∫–∏ –¥–∏–∑–∞–π–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'login' %}">–≤–æ–π—Ç–∏</a> –∏–ª–∏ <a href="{% url 'register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h5 class="card-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</span>
                                            <span class="text-muted">{{ design.get_file_extension }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</span>
                                            <span class="text-muted">{{ design.created_at|date:"d.m.Y" }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                                            <span class="text-muted">{{ design.category.name }}</span>
                                        </li>
                                    </ul>
                                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                                    {% if purchased %}
                                    <div class="mt-3">
                                        <a href="{{ design.design_file.url }}" class="btn btn-success btn-lg w-100" download="{{ design.title }}.{{ design.get_file_extension|lower }}">
                                            <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å {{ design.get_file_extension }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ—Ö–æ–∂–∏–µ –¥–∏–∑–∞–π–Ω—ã -->
    {% if similar_designs %}
    <div class="row mt-5">
        <div class="col-12">
            <h3>–ü–æ—Ö–æ–∂–∏–µ –¥–∏–∑–∞–π–Ω—ã</h3>
            <div class="row">
                {% for similar in similar_designs %}
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <img src="{{ similar.image_preview.url }}" class="card-img-top" alt="{{ similar.title }}" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">{{ similar.title|truncatewords:4 }}</h6>
                            <p class="card-text"><small class="text-muted">${{ similar.price }}</small></p>
                            <a href="{% url 'item_info' similar.id %}" class="btn btn-sm btn-outline-primary w-100">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                        </div>
                    </div>
                </div>
                {% if similar_designs %}
                    {% comment %} <p>–ù–∞–π–¥–µ–Ω–æ {{ similar_designs.count }} –ø–æ—Ö–æ–∂–∏—Ö –¥–∏–∑–∞–π–Ω–æ–≤</p> {% endcomment %}
                {% else %}
                    <p>–ü–æ—Ö–æ–∂–∏—Ö –¥–∏–∑–∞–π–Ω–æ–≤ –Ω–µ—Ç</p>
                {% endif %}

                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.design-card {
    position: relative;
}

.design-like {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 2;
}

.like-btn {
    font-size: 28px;        /* —Ä–∞–∑–º–µ—Ä —Å–µ—Ä–¥–µ—á–∫–∞ */
    background: none;
    border: none;
    cursor: pointer;
    color: #bbb;            /* —Å–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    transition: transform 0.2s ease, color 0.2s ease;
}

.like-btn .heart-icon {
    color: #bbb; /* default */
    transition: color 0.2s ease, transform 0.2s ease;
    font-size: 28px;
}

.like-btn:hover {
    transform: scale(1.02);
}

.like-btn.active .heart-icon {
    color: #e63946 !important;  /* –∫—Ä–∞—Å–Ω–æ–µ, –∫–æ–≥–¥–∞ –ª–∞–π–∫–Ω—É—Ç–æ */
    transform: scale(1.05);
}

.like-btn:active {
    transform: scale(1.02);
}


.discount {
    background-color: #cfe556;
    border-radius: 15px;
    margin-top: 10px;
}
.discount p {
    margin: 5px;
    font-weight: bold;
    font-size: 25px;
    text-align: center;
    padding: 15px 5px;
}

.info-item {
    margin-bottom: 15px;
}

.action-buttons .btn {
    margin-bottom: 10px;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.badge {
    font-size: 0.9em;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card-header.bg-light {
    border-bottom: 1px solid rgba(0,0,0,0.125);
    padding: 1rem 1.25rem;
}

/* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Ç–µ–Ω–∏ —É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
.card .card {
    box-shadow: none;
    border: 1px solid rgba(0,0,0,0.125);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ */
.rating-stars {
    display: inline-flex;
    gap: 2px;
}

.star-rating .star {
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
    font-size: 1.2em;
}

.star-rating .star.filled {
    color: #ffc107;
}

.star-rating .star.hover {
    color: #ffc107;
}

.rating-buttons {
    display: flex;
    gap: 5px;
}

.rating-btn.active {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.purchase-stats .badge {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .rating-stats .row > div {
        margin-bottom: 1rem;
    }
    
    .purchase-stats {
        text-align: left !important;
    }
}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
<script src="{% static 'js/rating.js' %}"></script>
<script src="{% static 'js/favorite_designs.js' %}"></script>
{% endblock %}
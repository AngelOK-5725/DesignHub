{% extends 'base.html' %}
{% load static %}
{% block title %}
{{ design.title }}
{% endblock title %}

{% block content %}

<div class="container">
    <!-- Стильная карточка с навигацией в шапке -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <button onclick="window.history.back()" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left"></i> Назад
                        </button>
                        <h5 class="mb-0">Информация о дизайне</h5>
                        <a href="{% url 'design_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-th"></i> Все дизайны
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <img src="{{ design.image_preview.url }}" class="card-img-top" alt="{{ design.title }}" style="max-height: 500px; object-fit: contain;">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h1 class="card-title h2">{{ design.title }}</h1>
                                    <p class="text-muted">Категория: {{ design.category.name }}</p>
                                    
                                    <div class="mb-4">
                                        <h3 class="text-primary">${{ design.price }}</h3>
                                    </div>

                                    <!-- Рейтинг и статистика -->
                                    <div class="rating-stats mb-4">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <!-- Звезды рейтинга -->
                                                    <div class="rating-stars me-3">
                                                        {% with stats=design.get_rating_stats %}
                                                        <div class="star-rating" data-design-id="{{ design.id }}">
                                                            {% for i in "12345" %}
                                                                {% with i=i|add:0 %}
                                                                <span class="star {% if i <= stats.average %}filled{% endif %}" 
                                                                        data-rating="{{ i }}">
                                                                    <i class="fas fa-star"></i>
                                                                </span>
                                                                {% endwith %}
                                                            {% endfor %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ stats.average|default:0 }} ({{ stats.count }} оценок)
                                                        </small>
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="purchase-stats text-end">
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-shopping-cart"></i>
                                                        Куплено: {{ design.get_purchase_count }} раз
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Форма оценки для авторизованных пользователей -->
                                        {% if user.is_authenticated and not purchased %}
                                        <div class="user-rating mt-3">
                                            <form class="rating-form" method="post" action="{% url 'rate_design' design.id %}">
                                                {% csrf_token %}
                                                <small class="text-muted">Оцените этот дизайн:</small>
                                                <div class="rating-buttons mt-1">
                                                    {% for i in "12345" %}
                                                        {% with i=i|add:0 %}
                                                        <button type="submit" name="rating" value="{{ i }}" 
                                                                class="btn btn-sm btn-outline-warning rating-btn {% if design.get_user_rating.user == i %}active{% endif %}"
                                                                title="Оценить {{ i }} звезд">
                                                            <i class="fas fa-star"></i> {{ i }}
                                                        </button>
                                                        {% endwith %}
                                                    {% endfor %}
                                                </div>
                                            </form>
                                        </div>
                                        {% endif %}

                                        <!-- Информация о стежках и пяльцах -->
                                        <div class="design-specs mb-4">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <strong><i class="fas fa-shoe-prints"></i> Количество стежков:</strong>
                                                        <br>
                                                        <span class="badge bg-primary mt-1">{{ design.get_stitch_count_display }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="info-item">
                                                        <strong><i class="fas fa-vector-square"></i> Доступные пяльца:</strong>
                                                        <br>
                                                        <div class="mt-1">
                                                            {% for hoop in design.compatible_hoops.all %}
                                                            <span class="badge bg-info me-1" title="{{ hoop.compatible_machines }}">
                                                                {{ hoop.code }}
                                                            </span>
                                                            {% empty %}
                                                            <span class="text-muted">Не указано</span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="design-info mb-4">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <strong><i class="fas fa-robot"></i> Машины:</strong>
                                                    <br>
                                                    <span class="badge bg-secondary mt-1">{{ design.get_machine_type_display }}</span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="info-item">
                                                    <strong><i class="fas fa-ruler"></i> Размер:</strong>
                                                    <br>
                                                    <span class="badge bg-info mt-1">{{ design.design_size }} mm</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="description mb-4">
                                        <h5>Описание</h5>
                                        <p class="card-text">{{ design.description|linebreaks }}</p>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        {% if user.is_authenticated %}
                                            {% if purchased %}
                                                <button class="btn btn-success btn-lg w-100" disabled>
                                                    <i class="fas fa-check"></i> Уже куплено
                                                </button>
                                                <div class="text-center mt-2">
                                                    <a href="{% url 'my_designs' %}" class="btn btn-outline-primary">
                                                        <i class="fas fa-download"></i> Скачать в личном кабинете
                                                    </a>
                                                </div>
                                            {% else %}
                                                <a href="{% url 'create_payment' design.id %}" class="btn btn-primary btn-lg w-100">
                                                    <i class="fas fa-shopping-cart"></i> Купить за ${{ design.price }}
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            <div class="alert alert-warning">
                                                <p>Для покупки дизайна необходимо <a href="{% url 'login' %}">войти</a> или <a href="{% url 'register' %}">зарегистрироваться</a></p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Дополнительная информация -->
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h5 class="card-title">Техническая информация</h5>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Формат файла:</span>
                                            <span class="text-muted">{{ design.get_file_extension }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Дата добавления:</span>
                                            <span class="text-muted">{{ design.created_at|date:"d.m.Y" }}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Категория:</span>
                                            <span class="text-muted">{{ design.category.name }}</span>
                                        </li>
                                    </ul>
                                    <!-- Кнопка скачивания в технической информации -->
                                    {% if purchased %}
                                    <div class="mt-3">
                                        <a href="{{ design.design_file.url }}" class="btn btn-success btn-lg w-100" download="{{ design.title }}.{{ design.get_file_extension|lower }}">
                                            <i class="fas fa-download"></i> Скачать {{ design.get_file_extension }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Похожие дизайны -->
    {% if similar_designs %}
    <div class="row mt-5">
        <div class="col-12">
            <h3>Похожие дизайны</h3>
            <div class="row">
                {% for similar in similar_designs %}
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <img src="{{ similar.image_preview.url }}" class="card-img-top" alt="{{ similar.title }}" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">{{ similar.title|truncatewords:4 }}</h6>
                            <p class="card-text"><small class="text-muted">${{ similar.price }}</small></p>
                            <a href="{% url 'item_info' similar.id %}" class="btn btn-sm btn-outline-primary w-100">Подробнее</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.info-item {
    margin-bottom: 15px;
}

.action-buttons .btn {
    margin-bottom: 10px;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.badge {
    font-size: 0.9em;
}

/* Стили для главной карточки */
.card-header.bg-light {
    border-bottom: 1px solid rgba(0,0,0,0.125);
    padding: 1rem 1.25rem;
}

/* Убираем лишние тени у внутренних карточек */
.card .card {
    box-shadow: none;
    border: 1px solid rgba(0,0,0,0.125);
}

/* Стили для рейтинга */
.rating-stars {
    display: inline-flex;
    gap: 2px;
}

.star-rating .star {
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
    font-size: 1.2em;
}

.star-rating .star.filled {
    color: #ffc107;
}

.star-rating .star.hover {
    color: #ffc107;
}

.rating-buttons {
    display: flex;
    gap: 5px;
}

.rating-btn.active {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.purchase-stats .badge {
    font-size: 0.9em;
    padding: 0.5em 0.75em;
}

/* Адаптивность */
@media (max-width: 768px) {
    .rating-stats .row > div {
        margin-bottom: 1rem;
    }
    
    .purchase-stats {
        text-align: left !important;
    }
}
</style>

<!-- Подключаем JavaScript для рейтинга -->
<script src="{% static 'js/rating.js' %}"></script>
{% endblock %}